<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Modelo 3D - AJAX & Three.js + AR</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script type="module" src="https://unpkg.com/three@0.154.0/build/three.module.js"></script>
  <script type="module" src="https://unpkg.com/three@0.154.0/examples/jsm/loaders/GLTFLoader.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      display: flex; justify-content: center; align-items: center;
      background: #fff; font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #title, #modelSelector {
      position: absolute; left: 20px; background: rgba(255,255,255,0.9);
      padding: 8px 12px; border-radius: 5px; z-index: 10; border: 1px solid #ccc;
    }
    #title { top: 10px; font-size: 18px; font-weight: bold; }
    #modelSelector { top: 60px; font-size: 14px; }
    #loader {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.75); color: #fff; padding: 6px 12px;
      border-radius: 4px; font-size: 14px; display: none;
      z-index: 50;
    }
    #threeContainer, model-viewer {
      width: 60vw; height: 60vh; background: #fff; border: none; display: none;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>
  <div id="title">Levipark21 - Línea Qubiq</div>

  <select id="modelSelector">
    <option value="bichos.glb" selected>Qubiq</option>
    <option value="coco.glb">Cocodrilo</option>
    <option value="koa.glb">Koala</option>
    <option value="pingu.glb">Pingüino</option>
  </select>

  <!-- Model Viewer for AR -->
  <model-viewer
    id="modelViewer"
    alt="Modelo 3D"
    auto-rotate
    camera-controls
    ar
    ar-modes="scene-viewer webxr quick-look"
    ar-scale="auto"
    loading="eager"
    style="display:none"
  ></model-viewer>

  <!-- Three.js container for desktop -->
  <div id="threeContainer"></div>

  <div id="loader">Cargando modelo...</div>

  <script type="module">
    import { isARSupported } from './three-viewer.js';

    const selector = document.getElementById('modelSelector');
    const viewer = document.getElementById('modelViewer');
    const loader = document.getElementById('loader');
    const threeContainer = document.getElementById('threeContainer');

    let useAR = false;
    let modelURL = null;
    let currentObjectURL = null;

    // Detectar si AR está soportado
    async function decideViewer() {
      useAR = await isARSupported();
      viewer.style.display = useAR ? '' : 'none';
      threeContainer.style.display = useAR ? 'none' : '';
      return useAR;
    }

    // Cargar modelo .glb vía AJAX y mostrar en el visor adecuado
    async function loadModelAjax(file) {
      loader.textContent = 'Cargando modelo...';
      loader.style.display = 'block';

      // Limpiar modelo anterior en ambos visores
      if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
      if (!useAR) {
        const { clearThree } = await import('./three-viewer.js');
        clearThree(threeContainer);
      }

      try {
        const response = await fetch(file);
        if (!response.ok) throw new Error('Error al descargar el modelo');
        const blob = await response.blob();
        const objectURL = URL.createObjectURL(blob);
        currentObjectURL = objectURL;

        if (useAR) {
          viewer.src = objectURL;
          viewer.addEventListener('load', () => {
            loader.style.display = 'none';
          }, { once: true });
        } else {
          const { loadGLBToThree } = await import('./three-viewer.js');
          await loadGLBToThree(objectURL, threeContainer, () => loader.style.display = 'none');
        }
      } catch (e) {
        loader.textContent = 'Error al cargar el modelo';
        console.error(e);
      }
    }

    // Inicializar
    (async () => {
      await decideViewer();
      await loadModelAjax(selector.value);
    })();

    selector.addEventListener('change', () => {
      loadModelAjax(selector.value);
    });
  </script>
</body>
</html>
